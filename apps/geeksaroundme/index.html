<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>
        </title>
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.css" />
        <style>
            /* App custom styles */
        </style>
        <script type="text/javascript">
          <%- yield(); %>
        </script>
        <script type="text/javascript" src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
        <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false&libraries=places"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.0.1/jquery.mobile-1.0.1.min.js"></script>
        <script src="http://jquery-ui-map.googlecode.com/svn/trunk/ui/min/jquery.ui.map.full.min.js"></script>
    </head>
    <body>
        <div data-role="page" id="page1">
            <div data-theme="a" data-role="header">
                <h3>
                    WHERE MY NERDS AT?!?
                </h3>
            </div>
            <div data-role="content">
                <div id="map_canvas" style="height:200px;"></div>
                <input type="submit" class="triangulate" data-theme="b" data-icon="search" data-iconpos="left" value="Triangulate" />
            </div>
        </div>
        <script>
        var Map;
        var failure = false;
            $('#page1').live('pageinit', function() {
                $('#map_canvas').gmap({zoom:10, height: 200, 'callback': function() {
                    var self = this;
                    Map = this;

                    var navigatorTimeout = setTimeout(function() {
                        failure = true;
                        var clientPosition = new google.maps.LatLng(window.params.lat, window.params.long);
                        self.instance.map.setCenter(clientPosition);
                        var marker = new google.maps.Marker({
                            position: clientPosition,
                            map: self.instance.map,
                            title: "Hello World!",
                            clickable: true
                        });
                        
                        self.instance.map.setZoom(13);
                    }, 5000);
                    var error = function(err) {
                    }
                    var success = function(pos) {
                        clearTimeout(navigatorTimeout);
                        var clientPosition = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
                        self.instance.map.setCenter(clientPosition);
                        var marker = new google.maps.Marker({
                            position: clientPosition,
                            map: self.instance.map,
                            title: "Hello World!",
                            clickable: true
                        });
                        self.instance.map.setZoom(13);
                    }
                    navigator.geolocation.getCurrentPosition(success, error);

                }});
            });

            $('.triangulate').bind('click', function(e) {
                console.log('click')
                var error = function() {}
                var success = function(pos) {
                    console.log('calling ajax')
                    $.ajax({
                        url: 'geeks.json?lat='+pos.coords.latitude+'&long='+pos.coords.longitude,
                        success: function(response) {
                            console.log('SUCCESS ',response);
                            if(response.profiles) {
                                _(_.groupBy(response.profiles, function(profile) {
                                    return profile.venue_name;
                                })).each(function(value, name) {
                                    var profile = value[0];
                                    var clientPosition = new google.maps.LatLng(profile.lat, profile.long);
                                    var marker = new google.maps.Marker({
                                        position: clientPosition, 
                                        map: Map.instance.map,
                                        title: "Hello World!",
                                        clickable: true
                                    });
                                    html = '';
                                    _.each(value, function(profile) {
                                        html += "<li style='display:block;list-style-type:none;overflow:hidden;'><img src='"+profile.avatar_url+"' style='height:25px;float:left' /><span style='padding-left:5px;font-size:12px;display:block;float:left;'>"+profile.name+"</span></li>"
                                    });
                                    
                                    
                                    google.maps.event.addListener(marker, 'click', function() {
                                        var info = new google.maps.InfoWindow({
                                            content: "<h1 style='display:block;font-size:13px;padding:2px;margin:0 0 4px 0;border-bottom:1px solid #f0f0f0;'>"+name+"</h1><ul style='padding:0;margin:0;list-style-type:none;display:block'>"+html+"</ul>",
                                            anchor: marker
                                        })
                                    });
                                }, this);
                            }
                        },
                        error: function(err) {
                            console.log('ERROR ', err)
                        }
                    });
                }
                if (!failure) {
                    navigator.geolocation.getCurrentPosition(success, error);
                } else {
                    success({coords: {latitude: window.params.lat, longitude: window.params.long}});
                }
            });
            //App custom javascript
        </script>
    </body>
</html>
